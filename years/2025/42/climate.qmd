---
title: "Historic UK meteorological & climate data"
format:
  html:
    sidebar: true
    code-fold: true
page-layout: article
---
<!-- Setup -->

```{r library, include=FALSE}
pacman::p_load(scales, here, fs, readxl, writexl, tidyverse, magrittr, broom, gridExtra, ggpmisc, rlang, xfun, usethis, devtools, lubridate, ggdark)
```

<!-- Get data -->

```{r setup, include=FALSE}
historic_station_met <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-10-21/historic_station_met.csv")

station_meta <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-10-21/station_meta.csv")

write_csv(historic_station_met, here("years", "2025", "42", "data", "historic_station_met.csv"))

write_csv(station_meta, here("years", "2025", "42", "data", "station_meta.csv"))
```


<!-- # Background

## Potential questions

How has temperature changed over time accross the different countries in the UK?

Does rainfall change across the different countries in the UK?

# Analysis

## Summary statistics -->


```{r summary, include=FALSE}
summary(historic_station_met)
# years range from 1850 - 2024
# mean daily temperature max ranges from -0.9 to 28.3
# mean daily temperature minimum ranges from -8.6 to 17
# days with air frost range from 0 - 31
# rainfall range from 0mm - 568.80mm (month)
# sunshine hours range from 2.8hours - 350.3 (month)


unique(historic_station_met$station)
# 37 total stations

# Northern Ireland

NI <- c("armagh", "ballypatrick")

# Scotland

SCO <- c(
  "braemar", "dunstaffnage", "eskdalemuir", "lerwick",
  "leuchars", "nairn", "paisley", "stornoway", "tiree", "wickairport"
)

# Wales

WAL <- c("aberporth", "cardiff", "cwmystwyth")

# England

ENG <- c(
  "bradford", "camborne", "cambridge", "chivenor", "durham",
  "eastbourne", "heathrow", "hurn", "lowestoft", "manston",
  "newtonrigg", "oxford", "ringway", "rossonwye", "shawbury",
  "sheffield", "southampton", "suttonbonington", "valley",
  "waddington", "whitby", "yeovilton"
)

# Adding country information to dataset

station_met_country <- historic_station_met |>
  mutate(country = case_when(
    station %in% NI ~ "Northern Ireland",
    station %in% SCO ~ "Scotland",
    station %in% WAL ~ "Wales",
    station %in% ENG ~ "England"
  ))
station_met_country

historic_station_met |>
  count(station, sort = TRUE)
# not every station has same number of entries;
#   armagh has the most at n = 2064,
#   camborne the fewest at n = 556

historic_station_met |>
  group_by(station) |>
  summarise(
    start_year = min(year, na.rm = TRUE),
    end_year = max(year, na.rm = TRUE),
    total_years = n_distinct(year)
  )
# confirming coverage is different across the stations

# finding years where countries have coverage:

station_met_country |>
  group_by(country) |>
  summarise(
    start_year = min(year, na.rm = TRUE),
    end_year = max(year, na.rm = TRUE)
  )

# england: 1853 - 2024
# northern ireland: 1853 - 2024
# scotland: 1873 - 2024
# wales: 1941 - 2024

station_met_country |>
  group_by(country) |>
  summarise(
    start_year = min(year, na.rm = TRUE),
    end_year = max(year, na.rm = TRUE)
  ) |>
  summarise(
    shared_start = max(start_year),
    shared_end = min(end_year)
  )

# analysis should be done from 1942 onwards
```

## How has temperature changed over time accross the different countries in the UK?

```{r include=FALSE}
# Look at how temp change has changed per country from 1942-1952 to 2012-2022?
#   Around 70 years of change

# -- define early period
earlystart <- 1942
earlyend <- 1952

# -- define late period
recentstart <- 2012
recentend <- 2022

# -- select years in two periods, drop others and label

period_df <- station_met_country |>
  filter(year %in% c(earlystart:earlyend, recentstart:recentend)) |>
  mutate(period = case_when(
    year %in% earlystart:earlyend ~ paste0(earlystart, "_", earlyend),
    year %in% recentstart:recentend ~ paste0(recentstart, "_", recentend)
  ))

# -- have rows of 12 months per year. need to average into yearly values (one value per station)

period_avg <- period_df |>
  group_by(station, country, year, period) |>
  summarise(
    annual_tmax = mean(tmax, na.rm = TRUE),
    annual_tmin = mean(tmin, na.rm = TRUE),
    .groups = "drop"
  )

# -- calculate mean for each station across the 10 year period (one value per station per period)

station_period_avg <- period_avg |>
  group_by(country, station, period) |>
  summarise(
    station_mean_tmax = mean(annual_tmax, na.rm = TRUE),
    station_mean_tmin = mean(annual_tmin, na.rm = TRUE),
    .groups = "drop"
  )

# -- calculate mean for each country across 10 year period (one value per country per period)

country_period_avg <- station_period_avg |>
  group_by(country, period) |>
  summarise(
    mean_tmax = mean(station_mean_tmax, na.rm = TRUE),
    mean_tmin = mean(station_mean_tmin, na.rm = TRUE),
    .groups = "drop"
  )

# -- pivot wide so columns are unique for periods to allow for calculation of temp change

cpa_wide <- country_period_avg |>
  pivot_wider(
    names_from = period,
    values_from = c(mean_tmax, mean_tmin),
    names_sep = "_"
  )

# -- calulcate temperature change from 1942-1952 to 2012-2022 (i.e., recent - early) and tidy for plotting

temp_change <- cpa_wide |>
  mutate(
    change_tmax = mean_tmax_2012_2022 - mean_tmax_1942_1952,
    change_tmin = mean_tmin_2012_2022 - mean_tmin_1942_1952
  ) |>
  select(
    country, change_tmax, change_tmin,
    starts_with("mean_tmax_"), starts_with("mean_tmin_")
  ) |>
  pivot_longer(
    cols = c(change_tmax, change_tmin),
    names_to = "variable",
    values_to = "change"
  ) |>
  mutate(
    variable = recode(variable, "change_tmax" = "Max Temp", "change_tmin" = "Min Temp"),
    change_label = if_else(is.na(change), "NA", sprintf("%+.2f°C", change))
  ) |>
  ungroup()

# -- reorder for sake of plotting

temp_change <- temp_change |>
  mutate(country = fct_reorder(country, change))
```

```{r temperature-change, fig.width=10, fig.height=6}
plot_temp_change <- temp_change |>
  ggplot(aes(x = country, y = change, fill = variable)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(aes(label = change_label, hjust = ifelse(change >= 0, -0.08, 1.08)),
    position = position_dodge(width = 0.8),
    size = 3.5, color = "black"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey20", linewidth = 0.75) +
  coord_flip(clip = "off") +
  scale_fill_manual(values = c("Max Temp" = "#fdae61", "Min Temp" = "#91bfdb"), name = NULL) +
  scale_y_continuous(
    expand = expansion(mult = c(0.15, 0.15)),
    breaks = pretty_breaks(n = 8)
  ) +
  labs(
    title = paste0("Change in mean annual temperature (", earlystart, "-", earlyend, " to ", recentstart, "-", recentend, ")"),
    subtitle = "Average change in station temperatures per country",
    y = "Change (°C)", x = NULL,
    caption = "Averages attained by averaging at the station level for the period, then annually, then per country.\nData: UK Met Office | Visualisation: Lewis TJ Ward"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    plot.subtitle = element_text(size = 11, margin = margin(b = 6)),
    plot.caption = element_text(size = 9, color = "grey50"),
    axis.text.y = element_text(size = 11),
    axis.title.x = element_text(size = 11),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "grey90", linewidth = 0.3),
    legend.position = "right",
    legend.key.size = unit(0.9, "lines"),
    plot.margin = margin(8, 18, 8, 8)
  )

ggsave(here("years", "2025", "42", "output", "mean annual temp changes.png"),
  plot = plot_temp_change, width = 10, height = 6, dpi = 300
)

plot_temp_change
```

## Does rainfall change across the different countries in the UK?

```{r include=FALSE}
# -- summarise annual rainfall per station
annual_rain <- station_met_country |>
  group_by(country, station, year) |>
  summarise(annual_rainfall = sum(rain, na.rm = TRUE), .groups = "drop") |>
  arrange(annual_rainfall)

# -- check how many zero rainfall entries exist
annual_rain |>
  summarise(zero_entries = sum(annual_rainfall == 0, na.rm = TRUE))
# 61 stations had 0 mm rainfall; assume these are missing values

# -- convert 0 mm to NA
annual_rain <- annual_rain |>
  mutate(annual_rainfall = na_if(annual_rainfall, 0))

# -- calculate mean annual rainfall per country
country_annual_rain <- annual_rain |>
  group_by(country, year) |>
  summarise(mean_annual_rain = mean(annual_rainfall, na.rm = TRUE), .groups = "drop")

# -- check starting year per country
country_annual_rain |>
  group_by(country) |>
  summarise(start_year = min(year, na.rm = TRUE))

# -- filter to last 25 years for clarity
country_annual_rain <- country_annual_rain |>
  filter(year >= 1989)

# -- classify years by rainfall percentile
country_annual_rain <- country_annual_rain |>
  group_by(country) |>
  mutate(
    drought_flag = case_when(
      mean_annual_rain < quantile(mean_annual_rain, 0.05, na.rm = TRUE) ~ "<5th percentile",
      mean_annual_rain < quantile(mean_annual_rain, 0.25, na.rm = TRUE) ~ "<25th percentile",
      TRUE ~ "≥25th percentile"
    )
  ) |>
  ungroup()

# -- calculate long-term mean and anomalies
country_annual_rain <- country_annual_rain |>
  group_by(country) |>
  mutate(
    mean_rain_lta = mean(mean_annual_rain, na.rm = TRUE),
    rain_anomaly = mean_annual_rain - mean_rain_lta
  ) |>
  ungroup()

# -- ensure consistent ordering of factors
country_annual_rain$drought_flag <- factor(
  country_annual_rain$drought_flag,
  levels = c("<5th percentile", "<25th percentile", "≥25th percentile")
)
```

```{r rainfall-change, fig.width=10, fig.height=6}
plot_rain_anomaly_year <- country_annual_rain |>
  ggplot(aes(x = year, y = rain_anomaly, fill = drought_flag)) +
  geom_vline(xintercept = country_annual_rain$year, color = "grey80", linetype = "dotted", linewidth = 0.3) +
  geom_col(width = 0.6) +
  geom_text(
    data = subset(country_annual_rain, drought_flag == "<5th percentile"),
    aes(
      label = year,
      vjust = ifelse(rain_anomaly >= 0, -0.2, 1.2)
    ), # proportional offset
    size = 3.5,
    fontface = "bold",
    color = "black"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey20", linewidth = 0.75) +
  facet_wrap(~country, scales = "fixed") +
  scale_x_continuous(breaks = seq(min(country_annual_rain$year),
    max(country_annual_rain$year),
    by = 5
  )) +
  scale_fill_manual(
    values = c(
      "<5th percentile" = "#d7191c",
      "<25th percentile" = "#fdae61",
      "≥25th percentile" = "#91bfdb"
    ),
    labels = c(
      "<5th percentile" = "<5th percentile",
      "<25th percentile" = "<25th percentile",
      "≥25th percentile" = "≥25th percentile"
    ),
    name = "Annual Rainfall\nPercentile"
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0.15, 0.15)),
    breaks = pretty_breaks(n = 8)
  ) +
  labs(
    title = "Average annual rainfall versus long-term mean per country (1989-2024)",
    subtitle = "<5th percentile years labeled in red; <25th percentile years in orange",
    y = "Difference from long-term average (mm)", x = "Year",
    caption = "Difference calculated as annual rainfall minus long-term mean per station and country.\nData source: UK Met Office | Visualisation: Lewis TJ Ward"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    # plot.subtitle = element_text(size = 11, margin = margin(b = 6)),
    plot.caption = element_text(size = 9, color = "grey50"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x = element_text(size = 11),
    panel.grid.major.y = element_line(color = "grey90", linewidth = 0.3),
    panel.grid.major.x = element_blank(),
    legend.position = "right",
    legend.key.size = unit(0.9, "lines"),
    plot.margin = margin(8, 18, 8, 8),
    strip.background = element_blank(),
    strip.text = element_text(face = "bold", size = 12)
  )

ggsave(here("years", "2025", "42", "output", "annual rainfall changes.png"),
  plot = plot_rain_anomaly_year, width = 11, height = 6, dpi = 300
)

plot_rain_anomaly_year
```
